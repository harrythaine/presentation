name: Deploy Chatbot

on:
  workflow_dispatch:
    inputs:
      manual-trigger:
        description: 'Manually trigger the workflow'
        default: 'true'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Setup AWS Credentials
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> $GITHUB_ENV
        echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> $GITHUB_ENV

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: 1.0.9
    
    - name: Debug Directory Content
      run: ls -R
    
    - name: Debug Docker Build Context
      run: |
        cd ./.github/chatbotterraform/ecs
        ls -R
     
    - name: Terraform Init
      run: terraform init

    - name: Terraform Validate
      run: terraform validate

    - name: Build and Push Docker Image
      run: |
        cd ./.github/chatbotterraform/ecs
        docker build -t ghcr.io/${{ github.repository }}/htb-bot:latest .
        docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
        docker push ghcr.io/${{ github.repository }}/htb-bot:latest
    
    - name: Terraform Init (ECS)
      run: terraform init ./.github/chatbotterraform

    - name: Terraform Validate (ECS)
      run: terraform validate ./.github/chatbotterraform

    - name: Terraform Plan
      run: terraform plan ./.github/chatbotterraform

    - name: Confirm Deployment
      run: |
        echo "This is a manual approval step."
        echo "Review the Terraform plan and confirm whether to deploy or not."

    - name: Terraform Apply
      if: github.event.inputs.manual-trigger == 'true'
      env:
        TF_VAR_aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        TF_VAR_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: terraform apply -auto-approve ./.github/chatbotterraform

    - name: Confirm Destroy
      run: |
        echo "This is a manual approval step to destroy what was just created."
        echo "Review the Terraform plan and confirm whether to destroy or not."

    - name: Terraform Destroy
      if: github.event.inputs.manual-trigger == 'true'
      env:
        TF_VAR_aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        TF_VAR_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: terraform destroy -auto-approve ./.github/chatbotterraform
